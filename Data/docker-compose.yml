services:
  spark-master:
    image: bitnami/spark:3.4.0
    container_name: spark-master
    environment:
      - SPARK_MODE=master
    ports:
      - "7077:7077"    # Spark master service port
      - "8080:8080"    # Spark master Web UI
    volumes:
      - ./conf/spark-defaults.conf:/opt/bitnami/spark/conf/spark-defaults.conf
      - ./notebooks:/home/jovyan/work
      - ./data:/home/jovyan/work/data
      - ./delta:/home/jovyan/work/delta

  spark-worker:
    image: bitnami/spark:3.4.0
    container_name: spark-worker
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
    depends_on:
      - spark-master
    volumes:
      - ./conf/spark-defaults.conf:/opt/bitnami/spark/conf/spark-defaults.conf
      - ./notebooks:/home/jovyan/work
      - ./data:/home/jovyan/work/data
      - ./delta:/home/jovyan/work/delta

  spark-thrift:
    image: bitnami/spark:3.4.0
    container_name: spark-thrift
    command: spark-class org.apache.hive.jdbc.HiveDriver
    depends_on:
      - spark-master
    ports:
      - "10000:10000"
    volumes:
      - ./conf/spark-defaults.conf:/opt/bitnami/spark/conf/spark-defaults.conf

  jupyter:
    build:
      context: .
      dockerfile: Dockerfile.jupyter
    image: jupyter/pyspark-notebook:latest
    container_name: jupyter
    environment:
      - PYSPARK_SUBMIT_ARGS=--master spark://spark-master:7077 --packages io.delta:delta-core_2.12:2.4.0 --conf spark.sql.extensions=io.delta.sql.DeltaSparkSessionExtension --conf spark.sql.catalog.spark_catalog=org.apache.spark.sql.delta.catalog.DeltaCatalog pyspark-shell
    ports:
      - "8888:8888"
    depends_on:
      - spark-master
    volumes:
      - ./notebooks:/home/jovyan/work
      - ./data:/home/jovyan/work/data
      - ./delta:/home/jovyan/work/delta

  kafka:
    image: confluentinc/cp-kafka:latest
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092

  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    container_name: zookeeper
    ports:
      - "2181:2181"

  airflow:
    image: puckel/docker-airflow:latest
    container_name: airflow
    restart: always
    environment:
      - LOAD_EX=n
    volumes:
      - ./dags:/usr/local/airflow/dags
    ports:
      - "8081:8080"
    depends_on:
      - spark-master

  superset:
    image: apache/superset:latest
    container_name: superset
    ports:
      - "8088:8088"
    environment:
      - SUPERSET_LOAD_EXAMPLES=yes

  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - superset
      - airflow

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
